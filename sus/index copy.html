<!DOCTYPE html>
<html>
<head>
    <title>CSV Loader & SQL Runner</title>
    <style>
        body { font-family: Arial; background: #fcf9d6; padding: 20px; }
        input[type=text] { width: 120px; margin-right: 5px; }
        button { padding: 8px 14px; margin: 5px; background: #c7dfd1; border-radius: 6px; }
        #resultBox { width: 100%; height: 200px; background: white; border: 1px solid black; overflow: auto; }
        #tableContainer { max-height: 200px; overflow: auto; border:1px solid #444; background:white; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #aaa; padding: 6px; text-align: left; }
        .prebuiltBox { margin-top: 10px; }
    </style>
</head>
<body>

<h2>Import File</h2>
<input type="file" id="fileInput"><br><br>

<!-- Input Fields -->
<div>
   <input type="text" id="nameField" placeholder="Name (max 25)">
<input type="text" id="idField" placeholder="ID">

<input type="text" id="pieceField" placeholder="Piece Count">
<input type="text" id="yearField" placeholder="Year">
<input type="text" id="priceField" placeholder="Price">
<input type="text" id="themeField" placeholder="Theme">
<input type="text" id="ppField" placeholder="Piece per $">

<button id="addBtn">Create New</button>
</div>

<br>

<div id="tableContainer"></div>

<br>

<!-- SQL Runner -->
<textarea id="sqlInput" style="width:300px;height:120px;"></textarea>
<button id="runSqlBtn" style="background:#bfe1d4;font-size:16px;">Run SQL</button>

<div id="resultBox"></div>

<h3>Prebuilt SQL Queries</h3>
<div class="prebuiltBox">
    <button class="prebuilt" data-sql="SELECT * FROM data">Show All</button>
    <button class="prebuilt" data-sql="SELECT * FROM data WHERE Price > 100">Sets Price > 100</button>
    <button class="prebuilt" data-sql="SELECT * FROM data WHERE Year > 2020">Newer Than 2020</button>
    <button class="prebuilt" data-sql="SELECT Name, Theme FROM data">Names & Themes</button>
    <button class="prebuilt" data-sql="SELECT * FROM data ORDER BY PieceCount DESC">Sort by Piece Count</button>
    <button class="prebuilt" data-sql="SELECT * FROM data ORDER BY Price DESC">Sort by Price</button>
    <button class="prebuilt" data-sql="SELECT * FROM data WHERE Theme = 'Star Wars'">Theme = Star Wars</button>
    <button class="prebuilt" data-sql="SELECT * FROM data WHERE PiecePerDollar < 10">Best Value Sets</button>
</div>

<script>
// In-memory "database"
let tableData = [];

// Render table to screen
function renderTable() {
    if (tableData.length === 0) {
        document.getElementById("tableContainer").innerHTML = "<i>No data loaded.</i>";
        return;
    }

    // Get the actual headers from the data
    let actualColumns = Object.keys(tableData[0]);

    // Try to detect Name & ID (case-insensitive)
    let nameCol = actualColumns.find(c => c.toLowerCase() === "name");
    let idCol   = actualColumns.find(c => c.toLowerCase() === "id");

    // Build new ordered list safely
    let columnOrder = [];

    if (nameCol) columnOrder.push(nameCol);
    if (idCol)   columnOrder.push(idCol);

    // Add the rest of the columns (excluding Name & ID)
    actualColumns.forEach(col => {
        if (col !== nameCol && col !== idCol)
            columnOrder.push(col);
    });

    // Build table HTML
    let html = "<table><tr>";
    columnOrder.forEach(col => html += `<th>${col}</th>`);
    html += "</tr>";

    tableData.forEach(row => {
        html += "<tr>";
        columnOrder.forEach(col => html += `<td>${row[col] ?? ""}</td>`);
        html += "</tr>";
    });

    html += "</table>";

    document.getElementById("tableContainer").innerHTML = html;
}


// Load CSV
document.getElementById("fileInput").addEventListener("change", function () {
    let file = this.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (e) {
        let lines = e.target.result.split("\n");
        let headers = lines[0].split(",");

        tableData = lines.slice(1).filter(l=>l.trim() !== "").map(line => {
            let values = line.split(",");
            let obj = {};
            headers.forEach((h,i)=> obj[h.trim()] = values[i] ? values[i].trim() : "");
            return obj;
        });

        renderTable();
    };
    reader.readAsText(file);
});

// Add Row
document.getElementById("addBtn").addEventListener("click", function () {
    let name = document.getElementById("nameField").value;
    if (name.length > 25) {
        alert("Name must be â‰¤ 25 characters.");
        return;
    }

    let newRow = {
        ID: document.getElementById("idField").value,
        Name: name,
        PieceCount: document.getElementById("pieceField").value,
        Year: document.getElementById("yearField").value,
        Price: document.getElementById("priceField").value,
        Theme: document.getElementById("themeField").value,
        PiecePerDollar: document.getElementById("ppField").value
    };

    tableData.push(newRow);
    renderTable();
});

// Simple SQL engine
function runSQL(sql) {
    sql = sql.trim().toUpperCase();

    // SELECT * FROM data
    if (sql === "SELECT * FROM DATA")
        return tableData;

    // WHERE conditions (very simple)
    if (sql.includes("WHERE")) {
        let left = sql.split("WHERE")[0].trim();
        let condition = sql.split("WHERE")[1].trim();

        let [col, op, value] = condition.split(" ");
        value = value.replace(/'/g, "");

        return tableData.filter(row => {
            let v = row[col];
            if (!v) return false;

            if (!isNaN(v)) v = parseFloat(v);
            if (!isNaN(value)) value = parseFloat(value);

            if (op === "=") return v == value;
            if (op === ">") return v > value;
            if (op === "<") return v < value;

            return false;
        });
    }

    // ORDER BY
    if (sql.includes("ORDER BY")) {
        let col = sql.split("ORDER BY")[1].trim();
        return [...tableData].sort((a,b)=> (a[col]>b[col] ? -1 : 1));
    }

    return [{Error:"Unsupported SQL"}];
}

// Run SQL button
document.getElementById("runSqlBtn").addEventListener("click", function () {
    let sql = document.getElementById("sqlInput").value;
    let result = runSQL(sql);
    document.getElementById("resultBox").innerText = JSON.stringify(result, null, 2);
});

// Prebuilt buttons
document.querySelectorAll(".prebuilt").forEach(btn => {
    btn.addEventListener("click", function () {
        let sql = this.dataset.sql;
        document.getElementById("sqlInput").value = sql;
        let result = runSQL(sql);
        document.getElementById("resultBox").innerText = JSON.stringify(result, null, 2);
    });
});
</script>

</body>
</html>
